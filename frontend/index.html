<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Focus Planner ‚Äî MiniApp (offline)</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://unpkg.com/pdfjs-dist@4.7.76/build/pdf.min.js"></script>
</head>
<body>
  <div class="safe-area"></div>

  <header class="app-header">
    <div class="brand">Focus Planner</div>
    <div class="header-actions">
    </div>
  </header>

  <nav class="tabs">
    <button class="tab active" data-tab="ai">ü§ñ AI</button>
    <button class="tab" data-tab="today">–°–µ–≥–æ–¥–Ω—è</button>
    <button class="tab" data-tab="goals">–¶–µ–ª–∏</button>
    <button class="tab" data-tab="pomodoro">–ü–æ–º–æ–¥–æ—Ä–æ</button>
  </nav>

  <section id="tab-ai" class="tab-panel active">
    <h1>ü§ñ AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç</h1>
    <div class="card ai-chat">
      <div id="aiChatHistory" class="chat-history">
        <div class="message bot">
          <div class="bubble">
            –ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –ù–∞–ø–∏—à–∏ –∑–∞–¥–∞—á–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ç—ã —Ö–æ—á–µ—à—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å, –∏ —è —Å–æ—Å—Ç–∞–≤–ª—é —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞ —Ç–µ–±—è!
          </div>
        </div>
      </div>

      <div id="aiTyping" class="typing-indicator hidden">
        <span></span><span></span><span></span>
      </div>

      <div class="chat-input-row">
        <button class="icon-btn mic-btn" id="btnVoice" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥">üé§</button>
        <input id="aiPrompt" class="input chat-input" type="text"
               placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Ö–æ—á—É —É—Å–ø–µ—Ç—å –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å—Å—è –∫ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π –¥–æ –∑–∞–≤—Ç—Ä–∞" />
        <button class="btn primary" id="btnAskAI" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">‚û§</button>
      </div>
    </div>
  </section>

  <main>
    <section id="tab-today" class="tab-panel">
      <h1>üìÖ –ü–ª–∞–Ω –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</h1>
      <div id="todayList" class="card-list"></div>

      <div class="toolbar">
        <button class="btn secondary" id="btnRebuild">üîÑ –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å</button>
        <button class="btn secondary" id="btnClearDone">üßπ –£–±—Ä–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
      </div>
    </section>

    <section id="tab-goals" class="tab-panel">
      <h1>üéØ SMART-—Ü–µ–ª–∏</h1>

      <div class="card">
        <label for="goalInput" class="label">–û–ø–∏—à–∏ —Ü–µ–ª—å –æ–¥–Ω–∏–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º</label>
        <textarea id="goalInput" class="input" rows="3" placeholder="–ù–∞–ø—Ä.: –ó–∞–ø—É—Å—Ç–∏—Ç—å –ª–µ–Ω–¥–∏–Ω–≥ –¥–ª—è —Å–±–æ—Ä–∞ –∑–∞—è–≤–æ–∫"></textarea>
        <button class="btn primary" id="btnGenerateSmart">‚ú® –†–∞–∑–±–∏—Ç—å –Ω–∞ –ø–æ–¥–∑–∞–¥–∞—á–∏</button>
      </div>

      <div id="smartResult" class="card-list"></div>
    </section>


    <section id="tab-pomodoro" class="tab-panel">
      <h1>‚è±Ô∏è –ü–æ–º–æ–¥–æ—Ä–æ</h1>

      <div class="pomodoro">
        <div class="timer" id="timerDisplay">25:00</div>
        <div class="segment">
          <label>–†–∞–±–æ—Ç–∞</label>
          <input id="workLen" type="number" min="5" max="90" value="25"> –º–∏–Ω
        </div>
        <div class="segment">
          <label>–ü–µ—Ä–µ—Ä—ã–≤</label>
          <input id="breakLen" type="number" min="3" max="30" value="5"> –º–∏–Ω
        </div>

        <div class="toolbar">
          <button class="btn primary" id="btnStart">‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç</button>
          <button class="btn secondary" id="btnPause">‚è∏ –ü–∞—É–∑–∞</button>
          <button class="btn danger" id="btnReset">‚ü≤ –°–±—Ä–æ—Å</button>
        </div>

        <div id="coach" class="coach"></div>
      </div>
    </section>

    <section id="tab-history" class="tab-panel">
      <h1>üóÇ –ò—Å—Ç–æ—Ä–∏—è –∏ –ø–æ–∏—Å–∫</h1>

      <div class="card">
        <input id="searchInput" class="input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∑–∞–¥–∞—á–∞–º/–∑–∞–º–µ—Ç–∫–∞–º..." />
        <button class="btn secondary" id="btnSearch">üîé –ù–∞–π—Ç–∏</button>
      </div>

      <div id="historyList" class="card-list"></div>
    </section>
  </main>

  <button id="fab" class="fab" title="–ë—ã—Å—Ç—Ä–æ –¥–æ–±–∞–≤–∏—Ç—å">Ôºã</button>
<div id="sheet" class="sheet">
    <div class="sheet-content">
      <div class="sheet-header">
        <div class="sheet-title">–ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ</div>
        <button class="icon-btn" id="sheetClose">‚úñÔ∏è</button>
      </div>

      <div class="card">
        <label class="label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
        <input id="qaTitle" class="input" placeholder="–ù–∞–ø—Ä.: –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –æ—Ç—á—ë—Ç" />
      </div>

      <div class="row">
        <div class="card grow">
          <label class="label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
          <select id="qaPriority" class="input">
            <option value="1">p1 (–≤—ã—Å–æ–∫–∏–π)</option>
            <option value="2" selected>p2 (—Å—Ä–µ–¥–Ω–∏–π)</option>
            <option value="3">p3 (–Ω–∏–∑–∫–∏–π)</option>
          </select>
        </div>
        <div class="card grow">
          <label class="label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω)</label>
          <input id="qaMinutes" class="input" type="number" min="5" max="480" value="45" />
        </div>
      </div>

      <div class="card">
        <label class="label">–î–µ–¥–ª–∞–π–Ω (–æ–ø—Ü.)</label>
        <input id="qaDeadline" class="input" type="date" />
      </div>

      <div class="toolbar">
        <button class="btn primary" id="qaAdd">‚úÖ –î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <script>
    const $ = (q)=>document.querySelector(q);
    const $$ = (q)=>document.querySelectorAll(q);

    const uid = ()=> Math.random().toString(36).slice(2,10);
    const fmtHM = (d)=> d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
    const isToday = (dstr)=>{
      if(!dstr) return true;
      const d = new Date(dstr);
      const t = new Date();
      return d.getFullYear()===t.getFullYear() && d.getMonth()===t.getMonth() && d.getDate()===t.getDate();
    };

    $$(".tab").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        $$(".tab").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        const tab = btn.dataset.tab;
        $$(".tab-panel").forEach(p=>p.classList.remove("active"));
        $("#tab-"+tab).classList.add("active");
        if(tab==="today") renderToday?.();
        if(tab==="history") renderHistory?.();
      });
    });

    function greedyToday(list, maxMinutes=360){
      const pool = list
        .filter(t=>!t.done && isToday(t.deadline))
        .sort((a,b)=> a.priority-b.priority || new Date(a.created)-new Date(b.created));
      let left = maxMinutes;
      const plan = [];
      for(const t of pool){
        const est = t.minutes || 45;
        if(est<=left){ plan.push(t); left-=est; }
        if(left<=0) break;
      }
      return plan;
    }

    window.addEventListener("DOMContentLoaded", () => {
      const histBtn = $("#openHistory");
      if (histBtn) {
        histBtn.addEventListener("click", () => {
          $$(".tab").forEach(b => b.classList.remove("active"));
          document.querySelector('[data-tab="history"]').classList.add("active");
          $$(".tab-panel").forEach(p => p.classList.remove("active"));
          $("#tab-history").classList.add("active");
          if (typeof renderHistory === "function") renderHistory();
        });
      }
    });

    async function renderToday() {
      if (typeof loadTasks === "function") {
        await loadTasks();
      }
    }

    
  let pomoTimer = null;
  let pomoLeft = 25 * 60;
  let pomoMode = "work";

  function updatePomoDisplay() {
    const out = document.getElementById("timerDisplay");
    if (!out) return;

    const m = Math.floor(pomoLeft / 60).toString().padStart(2, "0");
    const s = Math.floor(pomoLeft % 60).toString().padStart(2, "0");
    out.textContent = `${m}:${s}`;
  }

  function setCoach(text) {
    const coach = document.getElementById("coach");
    if (coach) coach.textContent = text;
  }

  function startPomodoro() {
    const work = parseInt(document.getElementById("workLen").value) || 25;
    const brk  = parseInt(document.getElementById("breakLen").value) || 5;

    if (pomoMode === "work") pomoLeft = work * 60;
    else pomoLeft = brk * 60;

    if (pomoTimer) clearInterval(pomoTimer);

    pomoTimer = setInterval(() => {
      pomoLeft--;
      updatePomoDisplay();

      if (pomoLeft <= 0) {
        clearInterval(pomoTimer);
        pomoTimer = null;

        if (pomoMode === "work") {
          pomoMode = "break";
          setCoach("–û—Ç–ª–∏—á–Ω–æ! –í—Ä–µ–º—è –∫–æ—Ä–æ—Ç–∫–æ–≥–æ –æ—Ç–¥—ã—Ö–∞ ‚õ±Ô∏è");
        } else {
          pomoMode = "work";
          setCoach("–ü–æ–µ—Ö–∞–ª–∏! –ù–æ–≤—ã–π —Ä–∞–±–æ—á–∏–π —Ü–∏–∫–ª üí™");
        }

        startPomodoro();
      }
    }, 1000);

    if (pomoMode === "work") setCoach("–§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ –∑–∞–¥–∞—á–µ üî•");
    else setCoach("–û—Ç–¥—ã—Ö–∞–µ–º –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—Å—è üòå");
  }

  function pausePomodoro() {
    if (pomoTimer) {
      clearInterval(pomoTimer);
      pomoTimer = null;
      setCoach("–ü–∞—É–∑–∞ ‚ö†Ô∏è");
    }
  }

  function resetPomodoro() {
    clearInterval(pomoTimer);
    pomoTimer = null;
    pomoMode = "work";
    pomoLeft = (parseInt(document.getElementById("workLen").value) || 25) * 60;

    updatePomoDisplay();
    setCoach("–ì–æ—Ç–æ–≤ –Ω–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —Ü–∏–∫–ª!");
  }

  document.addEventListener("DOMContentLoaded", () => {
    const start = document.getElementById("btnStart");
    const pause = document.getElementById("btnPause");
    const reset = document.getElementById("btnReset");

    start?.addEventListener("click", startPomodoro);
    pause?.addEventListener("click", pausePomodoro);
    reset?.addEventListener("click", resetPomodoro);

    updatePomoDisplay();
  });

  async function generateSMART() {
    const input = document.getElementById("goalInput");
    const box = document.getElementById("smartResult");

    if (!input || !box) return;

    const text = input.value.trim();
    if (!text) {
      box.innerHTML = `<div class="empty-card">–í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª—å</div>`;
      return;
    }

    box.innerHTML = `<div class="empty-card">‚è≥ –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ü–µ–ª—å...</div>`;

    try {
      const res = await fetch(`${API}/ask`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
          prompt: `–†–∞–∑–±–µ–π —Ü–µ–ª—å –Ω–∞ SMART-–ø–æ–¥–∑–∞–¥–∞—á–∏. –§–æ—Ä–º–∞—Ç: —Å–ø–∏—Å–æ–∫ –ø—É–Ω–∫—Ç–æ–≤ –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ —Ç–µ–∫—Å—Ç–∞.\n–¶–µ–ª—å: ${text}`
        })
      });

      const data = await res.json();
      let answer = data.answer || "";

      const items = answer.split("\n").filter(x => x.trim().length > 0);

      box.innerHTML = "";
      items.forEach(t => {
        const card = document.createElement("div");
        card.className = "card";
        card.textContent = t.replace(/^[-‚Ä¢*]/, "").trim();
        box.appendChild(card);
      });

    } catch (e) {
      console.error(e);
      box.innerHTML = `<div class="empty-card">–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ AI</div>`;
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("btnGenerateSmart");
    if (btn) btn.addEventListener("click", generateSMART);
  });


async function addTaskFull() {
  const title = document.getElementById("qaTitle").value.trim();
  const priority = document.getElementById("qaPriority").value;
  const minutes = document.getElementById("qaMinutes").value;
  const deadline = document.getElementById("qaDeadline").value;

  if (!title) return;

  try {
    await fetch(
      `${API}/add_task?title=${encodeURIComponent(title)}&priority=${priority}&minutes=${minutes}&deadline=${deadline}`,
      { method: "POST" }
    );

    document.getElementById("qaTitle").value = "";
    document.getElementById("qaDeadline").value = "";
    document.getElementById("sheet").classList.remove("open");

    loadTasks();

  } catch (err) {
    console.error("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏:", err);
  }
}



document.addEventListener("DOMContentLoaded", () => {
  const qaAddBtn = document.getElementById("qaAdd");

  if (qaAddBtn)
    qaAddBtn.addEventListener("click", addTaskFull);
});



document.addEventListener("DOMContentLoaded", () => {
  const fab = document.getElementById("fab");
  const sheet = document.getElementById("sheet");

  if (fab && sheet) {
    fab.addEventListener("click", () => {
      sheet.classList.add("open");
    });
  }

  const sheetClose = document.getElementById("sheetClose");
  if (sheetClose && sheet) {
    sheetClose.addEventListener("click", () => {
      sheet.classList.remove("open");
    });
  }

  sheet.addEventListener("click", (e) => {
    if (e.target === sheet) {
      sheet.classList.remove("open");
    }
  });
});

  </script>

  <script src="script.js"></script>
</body>
</html>
